import { useState, useEffect, useRef } from 'react';
import useBopStore from '../store/bopStore';
import { api } from '../services/api';

function ToolsPanel() {
  const {
    exportBopData,
    setBopData,
    addMessage,
    normalizeAllProcesses,
  } = useBopStore();

  // Navigation
  const [view, setView] = useState('main'); // 'main' | 'upload' | 'detail' | 'generate'

  // Tool list
  const [tools, setTools] = useState([]);
  const [listLoading, setListLoading] = useState(false);

  // Upload & Analysis
  const [uploadedCode, setUploadedCode] = useState('');
  const [fileName, setFileName] = useState('');
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState(null);
  const [registering, setRegistering] = useState(false);

  // AI Script Generation
  const [genDescription, setGenDescription] = useState('');
  const [generating, setGenerating] = useState(false);
  const [generatedResult, setGeneratedResult] = useState(null);
  const [editedCode, setEditedCode] = useState('');

  // Detail
  const [selectedTool, setSelectedTool] = useState(null);
  const [toolDetail, setToolDetail] = useState(null);  // ì–´ëŒ‘í„° ì½”ë“œ í¬í•¨ ìƒì„¸ ì •ë³´
  const [executing, setExecuting] = useState(false);
  const [execResult, setExecResult] = useState(null);
  const [toolParams, setToolParams] = useState({});
  const [pendingResult, setPendingResult] = useState(null);
  const [originalBop, setOriginalBop] = useState(null);
  const [bopChanges, setBopChanges] = useState(null);

  // AI Improvement
  const [showImprove, setShowImprove] = useState(false);
  const [improveFeedback, setImproveFeedback] = useState('');
  const [improveScope, setImproveScope] = useState({ adapter: true, params: true, script: false });
  const [improving, setImproving] = useState(false);
  const [improveResult, setImproveResult] = useState(null);
  const [applying, setApplying] = useState(false);

  // Error
  const [error, setError] = useState('');

  // ë‹¤ì¤‘ ì„ íƒ
  const [selectedToolIds, setSelectedToolIds] = useState([]);

  const fileInputRef = useRef(null);

  // ë‹¤ìŒ ë²„ì „ ë²ˆí˜¸ ê³„ì‚°
  const getNextVersionLabel = (toolId) => {
    if (!toolId) return 'v2';
    // _v3, _v2 ë“±ì—ì„œ ë²„ì „ ë²ˆí˜¸ ì¶”ì¶œ
    const match = toolId.match(/_v(\d+)$/);
    if (match) {
      const currentVersion = parseInt(match[1], 10);
      return `v${currentVersion + 1}`;
    }
    return 'v2';  // ë²„ì „ì´ ì—†ìœ¼ë©´ v2
  };

  // BOP ë³€ê²½ ì‚¬í•­ ê³„ì‚°
  const computeBopChanges = (original, updated) => {
    if (!original || !updated) return null;

    const changes = [];
    const fieldNames = {
      processes: 'ê³µì •',
      equipments: 'ì„¤ë¹„',
      workers: 'ì‘ì—…ì',
      materials: 'ìì¬',
      obstacles: 'ì¥ì• ë¬¼'
    };

    // ë°°ì—´ ë¹„êµ (processes, equipments, workers, materials, obstacles)
    const arrayFields = ['processes', 'equipments', 'workers', 'materials', 'obstacles'];
    arrayFields.forEach(field => {
      const origArr = original[field] || [];
      const updArr = updated[field] || [];

      const added = updArr.length - origArr.length;
      if (added > 0) {
        changes.push({ type: 'add', field: fieldNames[field] || field, count: added });
      } else if (added < 0) {
        changes.push({ type: 'remove', field: fieldNames[field] || field, count: -added });
      }

      // ê¸°ì¡´ í•­ëª© ìˆ˜ì • ì²´í¬ (ID ê¸°ë°˜ ë¹„êµ)
      if (field === 'processes') {
        // ê³µì •: IDë¡œ ë§¤ì¹­í•˜ì—¬ ë¹„êµ
        let modified = 0;
        const modifiedDetails = [];
        origArr.forEach(origProc => {
          const updProc = updArr.find(p => p.process_id === origProc.process_id);
          if (updProc && JSON.stringify(origProc) !== JSON.stringify(updProc)) {
            modified++;
            // parallel_count ë³€ê²½ ê°ì§€
            if (origProc.parallel_count !== updProc.parallel_count) {
              modifiedDetails.push(`${origProc.name}: ë³‘ë ¬ ${origProc.parallel_count || 1} â†’ ${updProc.parallel_count || 1}`);
            }
            // cycle_time ë³€ê²½ ê°ì§€
            if (origProc.cycle_time_sec !== updProc.cycle_time_sec) {
              modifiedDetails.push(`${origProc.name}: CT ${origProc.cycle_time_sec}s â†’ ${updProc.cycle_time_sec}s`);
            }
          }
        });
        if (modified > 0) {
          changes.push({
            type: 'modify',
            field: fieldNames[field],
            count: modified,
            details: modifiedDetails.length > 0 ? modifiedDetails : null
          });
        }
      } else {
        // ë‹¤ë¥¸ í•„ë“œ: ìˆœì„œëŒ€ë¡œ ë¹„êµ
        const minLen = Math.min(origArr.length, updArr.length);
        let modified = 0;
        for (let i = 0; i < minLen; i++) {
          if (JSON.stringify(origArr[i]) !== JSON.stringify(updArr[i])) {
            modified++;
          }
        }
        if (modified > 0) {
          changes.push({ type: 'modify', field: fieldNames[field] || field, count: modified });
        }
      }
    });

    // ìŠ¤ì¹¼ë¼ í•„ë“œ ë¹„êµ
    const scalarFields = ['project_title', 'target_uph'];
    scalarFields.forEach(field => {
      if (original[field] !== updated[field]) {
        const scalarNames = { project_title: 'í”„ë¡œì íŠ¸ëª…', target_uph: 'ëª©í‘œ UPH' };
        changes.push({ type: 'modify', field: scalarNames[field] || field, count: 1 });
      }
    });

    return changes.length > 0 ? changes : null;
  };

  // Load tools on mount
  useEffect(() => {
    if (view === 'main') loadTools();
  }, [view]);

  const loadTools = async () => {
    setListLoading(true);
    try {
      const list = await api.listTools();
      setTools(list);
      setSelectedToolIds([]);  // ì„ íƒ ì´ˆê¸°í™”
    } catch (err) {
      setError(err.message);
    } finally {
      setListLoading(false);
    }
  };

  // === Upload View Handlers ===

  const handleFileSelect = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.name.endsWith('.py')) {
      setError('Python (.py) íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      return;
    }
    setError('');
    const reader = new FileReader();
    reader.onload = (ev) => {
      setUploadedCode(ev.target.result);
      setFileName(file.name);
      setAnalysisResult(null);
    };
    reader.readAsText(file);
  };

  const handleAnalyze = async () => {
    if (!uploadedCode) return;
    setAnalyzing(true);
    setError('');
    try {
      const result = await api.analyzeScript(uploadedCode, fileName);
      setAnalysisResult(result);
    } catch (err) {
      setError(err.message);
    } finally {
      setAnalyzing(false);
    }
  };

  const handleRegister = async () => {
    if (!analysisResult || !uploadedCode) return;
    setRegistering(true);
    setError('');

    console.log('[ToolsPanel] ë„êµ¬ ë“±ë¡ ì‹œì‘:', analysisResult.tool_name);
    console.log('[ToolsPanel] input_schema:', analysisResult.input_schema);
    console.log('[ToolsPanel] params_schema:', analysisResult.params_schema);

    try {
      const registerData = {
        tool_name: analysisResult.tool_name,
        description: analysisResult.description,
        execution_type: analysisResult.execution_type,
        file_name: fileName,
        source_code: uploadedCode,
        input_schema: analysisResult.input_schema,
        output_schema: analysisResult.output_schema,
        params_schema: analysisResult.params_schema || null,
      };
      console.log('[ToolsPanel] ë“±ë¡ ìš”ì²­ ë°ì´í„°:', registerData);

      const result = await api.registerTool(registerData);
      console.log('[ToolsPanel] ë“±ë¡ ì™„ë£Œ:', result);

      // Reset and go back to tools
      setUploadedCode('');
      setFileName('');
      setAnalysisResult(null);
      setView('main');
    } catch (err) {
      console.error('[ToolsPanel] ë“±ë¡ ì‹¤íŒ¨:', err);
      setError(err.message);
    } finally {
      setRegistering(false);
    }
  };

  // === Detail View Handlers ===

  const openDetail = async (tool) => {
    setSelectedTool(tool);
    setToolDetail(null);
    setExecResult(null);
    setPendingResult(null);
    setError('');
    // íŒŒë¼ë¯¸í„° ê¸°ë³¸ê°’ ì´ˆê¸°í™” (BOP ê°’ì„ fallbackìœ¼ë¡œ ì‚¬ìš©)
    const bopData = exportBopData();
    const defaults = {};
    (tool.params_schema || []).forEach(p => {
      if (p.default != null) {
        defaults[p.key] = p.default;
      } else if (bopData && bopData[p.key] != null) {
        // BOP fallback: BOPì— ê°™ì€ í‚¤ê°€ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
        defaults[p.key] = bopData[p.key];
      }
    });
    setToolParams(defaults);
    setView('detail');

    // ì–´ëŒ‘í„° ì½”ë“œë¥¼ í¬í•¨í•œ ìƒì„¸ ì •ë³´ ë¡œë“œ
    try {
      const detail = await api.getToolDetail(tool.tool_id);
      setToolDetail(detail);
    } catch (err) {
      console.error('[ToolsPanel] ë„êµ¬ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', err);
      // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ì–´ëŒ‘í„° ì½”ë“œë§Œ ì•ˆ ë³´ì¼ ë¿)
    }
  };

  const handleExecute = async () => {
    if (!selectedTool) return;
    setExecuting(true);
    setExecResult(null);
    setPendingResult(null);
    setOriginalBop(null);
    setBopChanges(null);
    setError('');

    console.log('[ToolsPanel] ë„êµ¬ ì‹¤í–‰ ì‹œì‘:', selectedTool.tool_id);

    try {
      const collapsedBop = exportBopData();
      if (!collapsedBop) {
        setError('ì‹¤í–‰í•  BOP ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € BOPë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
        setExecuting(false);
        return;
      }
      // ë¹ˆ ë¬¸ìì—´ì„ numberë¡œ ë³€í™˜í•˜ê³  ë¹ˆ ê°’ì€ ì œê±°
      const cleanParams = {};
      const schema = selectedTool.params_schema || [];
      schema.forEach(p => {
        const val = toolParams[p.key];
        if (val !== '' && val != null) {
          cleanParams[p.key] = p.type === 'number' ? Number(val) : val;
        }
      });

      console.log('[ToolsPanel] ì „ì†¡í•  params:', cleanParams);
      console.log('[ToolsPanel] BOP ìš”ì•½: processes=%d, obstacles=%d',
        collapsedBop.processes?.length || 0,
        collapsedBop.obstacles?.length || 0);

      const result = await api.executeTool(
        selectedTool.tool_id,
        collapsedBop,
        Object.keys(cleanParams).length > 0 ? cleanParams : null
      );

      console.log('[ToolsPanel] ì‹¤í–‰ ê²°ê³¼:', result);
      setExecResult(result);
      if (result.success && result.updated_bop) {
        const changes = computeBopChanges(collapsedBop, result.updated_bop);
        if (changes) {
          setOriginalBop(collapsedBop);
          setPendingResult(result);
          setBopChanges(changes);
        }
        // changesê°€ nullì´ë©´ BOP ë°˜ì˜ ë²„íŠ¼ì´ í‘œì‹œë˜ì§€ ì•ŠìŒ
      }
    } catch (err) {
      setExecResult({ success: false, message: err.message });
    } finally {
      setExecuting(false);
    }
  };

  const handleApplyToBop = () => {
    if (!pendingResult || !pendingResult.updated_bop || !bopChanges) return;

    // ë³€ê²½ ì‚¬í•­ ìš”ì•½ ìƒì„±
    const changeSummary = bopChanges.map(c => {
      if (c.type === 'add') return `${c.field} ${c.count}ê°œ ì¶”ê°€`;
      if (c.type === 'remove') return `${c.field} ${c.count}ê°œ ì‚­ì œ`;
      if (c.type === 'modify') return `${c.field} ${c.count}ê°œ ìˆ˜ì •`;
      return '';
    }).join('\n');

    const confirmed = confirm(`ë‹¤ìŒ ë³€ê²½ ì‚¬í•­ì„ BOPì— ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${changeSummary}`);
    if (!confirmed) return;

    setBopData(pendingResult.updated_bop);
    // BOP ë°˜ì˜ í›„ ê·¸ë¦¬ë“œ ì¬ê³„ì‚° (ëª¨ë“  ë„êµ¬ ê³µí†µ - ë³‘ë ¬ í™•ì¥, ê³µì • ìœ„ì¹˜ ì •ê·œí™”)
    setTimeout(() => normalizeAllProcesses(), 0);
    addMessage('assistant', `"${selectedTool.tool_name}" ë„êµ¬ ê²°ê³¼ê°€ BOPì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    setPendingResult(null);
    setBopChanges(null);
    setOriginalBop(null);
  };

  const handleCancelApply = () => {
    setPendingResult(null);
    setBopChanges(null);
    setOriginalBop(null);
  };


  const handleDelete = async () => {
    if (!selectedTool) return;
    if (!confirm(`"${selectedTool.tool_name}" ë„êµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    try {
      await api.deleteTool(selectedTool.tool_id);
      setSelectedTool(null);
      setSelectedToolIds([]);  // ì„ íƒ ì´ˆê¸°í™”
      setView('main');
    } catch (err) {
      setError(err.message);
    }
  };

  // ë‹¤ì¤‘ ì‚­ì œ
  const handleDeleteSelected = async () => {
    if (selectedToolIds.length === 0) return;
    if (!confirm(`ì„ íƒí•œ ${selectedToolIds.length}ê°œ ë„êµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    try {
      setListLoading(true);
      // ë³‘ë ¬ë¡œ ì‚­ì œ
      await Promise.all(selectedToolIds.map(id => api.deleteTool(id)));
      setSelectedToolIds([]);
      await loadTools();  // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (err) {
      setError(err.message);
    } finally {
      setListLoading(false);
    }
  };

  // ì²´í¬ë°•ìŠ¤ í† ê¸€
  const toggleToolSelection = (toolId, e) => {
    e.stopPropagation();  // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
    setSelectedToolIds(prev =>
      prev.includes(toolId)
        ? prev.filter(id => id !== toolId)
        : [...prev, toolId]
    );
  };

  // ì „ì²´ ì„ íƒ/í•´ì œ
  const toggleSelectAll = () => {
    if (selectedToolIds.length === tools.length) {
      setSelectedToolIds([]);
    } else {
      setSelectedToolIds(tools.map(t => t.tool_id));
    }
  };

  // === AI Script Generation Handlers ===

  const handleGenerate = async () => {
    if (!genDescription.trim()) return;
    setGenerating(true);
    setError('');
    setGeneratedResult(null);
    try {
      const result = await api.generateScript(genDescription);
      if (result.success) {
        setGeneratedResult(result);
        setEditedCode(result.script_code || '');
      } else {
        setError(result.message || 'ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setGenerating(false);
    }
  };

  const handleRegisterGenerated = async () => {
    if (!generatedResult || !editedCode) return;
    setRegistering(true);
    setError('');
    try {
      // ë¨¼ì € í¸ì§‘ëœ ì½”ë“œë¡œ ë¶„ì„ ì‹¤í–‰
      const analysisRes = await api.analyzeScript(editedCode, `${generatedResult.tool_name}.py`);

      // ë¶„ì„ ê²°ê³¼ë¡œ ë“±ë¡
      await api.registerTool({
        tool_name: analysisRes.tool_name || generatedResult.tool_name,
        description: analysisRes.description || generatedResult.description,
        execution_type: analysisRes.execution_type || 'python',
        file_name: `${generatedResult.tool_name}.py`,
        source_code: editedCode,
        input_schema: analysisRes.input_schema,
        output_schema: analysisRes.output_schema,
        params_schema: analysisRes.params_schema || generatedResult.suggested_params || null,
      });

      // Reset and go back
      setGenDescription('');
      setGeneratedResult(null);
      setEditedCode('');
      setView('main');
    } catch (err) {
      setError(err.message);
    } finally {
      setRegistering(false);
    }
  };

  // === AI Improvement Handlers ===

  const handleImprove = async () => {
    if (!selectedTool || !improveFeedback.trim()) return;
    setImproving(true);
    setError('');
    setImproveResult(null);

    console.log('[ToolsPanel] AI ê°œì„  ìš”ì²­:', selectedTool.tool_id);
    console.log('[ToolsPanel] í”¼ë“œë°±:', improveFeedback);
    console.log('[ToolsPanel] ìˆ˜ì • ë²”ìœ„:', improveScope);

    try {
      const result = await api.improveTool(selectedTool.tool_id, {
        userFeedback: improveFeedback,
        executionContext: execResult ? {
          success: execResult.success,
          stdout: execResult.stdout,
          stderr: execResult.stderr,
          tool_output: execResult.tool_output,
        } : null,
        modifyAdapter: improveScope.adapter,
        modifyParams: improveScope.params,
        modifyScript: improveScope.script,
      });

      console.log('[ToolsPanel] ê°œì„  ê²°ê³¼:', result);

      if (result.success) {
        setImproveResult(result);
      } else {
        setError(result.message || 'ê°œì„  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      console.error('[ToolsPanel] ê°œì„  ì‹¤íŒ¨:', err);
      setError(err.message);
    } finally {
      setImproving(false);
    }
  };

  const handleApplyImprovement = async (createNewVersion) => {
    if (!selectedTool || !improveResult?.preview) return;
    setApplying(true);
    setError('');

    console.log('[ToolsPanel] ê°œì„  ì ìš©:', createNewVersion ? 'ìƒˆ ë²„ì „' : 'ë®ì–´ì“°ê¸°');

    try {
      const result = await api.applyImprovement(selectedTool.tool_id, {
        preProcessCode: improveResult.preview.pre_process_code,
        postProcessCode: improveResult.preview.post_process_code,
        paramsSchema: improveResult.preview.params_schema,
        scriptCode: improveResult.preview.script_code,
        createNewVersion,
      });

      console.log('[ToolsPanel] ì ìš© ê²°ê³¼:', result);

      if (result.success) {
        addMessage('assistant', `"${selectedTool.tool_name}" ë„êµ¬ê°€ ${createNewVersion ? 'ìƒˆ ë²„ì „(' + result.tool_name + ')ìœ¼ë¡œ' : ''} ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        // Reset and go back
        setImproveResult(null);
        setImproveFeedback('');
        setShowImprove(false);
        setView('main');
      }
    } catch (err) {
      console.error('[ToolsPanel] ì ìš© ì‹¤íŒ¨:', err);
      setError(err.message);
    } finally {
      setApplying(false);
    }
  };

  // === Render ===

  const renderTools = () => (
    <div style={styles.content}>
      <div style={styles.header}>
        <h3 style={styles.title}>ë„êµ¬ ê´€ë¦¬</h3>
        <div style={{ display: 'flex', gap: 8 }}>
          <button style={styles.aiBtn} onClick={() => { setView('generate'); setError(''); setGeneratedResult(null); setGenDescription(''); }}>
            âœ¨ AI ìƒì„±
          </button>
          <button style={styles.secondaryBtn} onClick={() => { setView('upload'); setError(''); }}>
            + ì—…ë¡œë“œ
          </button>
        </div>
      </div>

      {/* ë‹¤ì¤‘ ì„ íƒ ë„êµ¬ */}
      {!listLoading && tools.length > 0 && (
        <div style={{ padding: '8px 12px', backgroundColor: '#f8f9fa', borderRadius: 4, marginBottom: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <label style={{ display: 'flex', alignItems: 'center', gap: 6, fontSize: 13, cursor: 'pointer', userSelect: 'none' }}>
            <input
              type="checkbox"
              checked={selectedToolIds.length === tools.length && tools.length > 0}
              onChange={toggleSelectAll}
              style={{ cursor: 'pointer' }}
            />
            <span>ì „ì²´ ì„ íƒ ({selectedToolIds.length}/{tools.length})</span>
          </label>
          {selectedToolIds.length > 0 && (
            <button
              style={{ ...styles.dangerBtn, padding: '4px 12px', fontSize: 12 }}
              onClick={handleDeleteSelected}
            >
              ì„ íƒ ì‚­ì œ ({selectedToolIds.length})
            </button>
          )}
        </div>
      )}

      {listLoading && <div style={styles.info}>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>}

      {!listLoading && tools.length === 0 && (
        <div style={styles.emptyState}>
          <p style={{ fontWeight: 'bold', marginBottom: 8 }}>ë“±ë¡ëœ ë„êµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
          <p style={{ color: '#888', fontSize: 13 }}>
            Python ìµœì í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì—…ë¡œë“œí•˜ì—¬<br />BOP ë°ì´í„°ì™€ ì—°ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>
      )}

      {tools.map(tool => (
        <div
          key={tool.tool_id}
          style={{
            ...styles.card,
            backgroundColor: selectedToolIds.includes(tool.tool_id) ? '#e3f2fd' : 'white'
          }}
          onClick={() => openDetail(tool)}
        >
          <div style={styles.cardHeader}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <input
                type="checkbox"
                checked={selectedToolIds.includes(tool.tool_id)}
                onChange={(e) => toggleToolSelection(tool.tool_id, e)}
                onClick={(e) => e.stopPropagation()}
                style={{ cursor: 'pointer' }}
              />
              <span style={styles.cardName}>{tool.tool_name}</span>
            </div>
            <span style={styles.badge}>{tool.execution_type}</span>
          </div>
          <div style={styles.cardDesc}>{tool.description}</div>
        </div>
      ))}

      {error && <div style={styles.error}>{error}</div>}
    </div>
  );

  const renderUpload = () => (
    <div style={styles.content}>
      <div style={styles.header}>
        <button style={styles.backBtn} onClick={() => setView('main')}>â† ëª©ë¡</button>
        <h3 style={styles.title}>ë„êµ¬ ì—…ë¡œë“œ</h3>
      </div>

      {/* Step 1: File Upload */}
      <div style={styles.section}>
        <label style={styles.label}>1. Python ìŠ¤í¬ë¦½íŠ¸ ì„ íƒ</label>
        <input
          ref={fileInputRef}
          type="file"
          accept=".py"
          onChange={handleFileSelect}
          style={{ display: 'none' }}
        />
        <button style={styles.secondaryBtn} onClick={() => fileInputRef.current?.click()}>
          {fileName || 'íŒŒì¼ ì„ íƒ...'}
        </button>
      </div>

      {/* Step 2: Code Preview */}
      {uploadedCode && (
        <div style={styles.section}>
          <label style={styles.label}>2. ì½”ë“œ ë¯¸ë¦¬ë³´ê¸°</label>
          <pre style={styles.codePreview}>
            {uploadedCode.length > 2000 ? uploadedCode.slice(0, 2000) + '\n...' : uploadedCode}
          </pre>
        </div>
      )}

      {/* Step 3: Analyze Button */}
      {uploadedCode && !analysisResult && (
        <div style={styles.section}>
          <label style={styles.label}>3. AI ë¶„ì„</label>
          <button
            style={styles.primaryBtn}
            onClick={handleAnalyze}
            disabled={analyzing}
          >
            {analyzing ? 'ë¶„ì„ ì¤‘...' : 'ë¶„ì„í•˜ê¸°'}
          </button>
        </div>
      )}

      {/* Step 4: Analysis Result */}
      {analysisResult && (
        <div style={styles.section}>
          <label style={styles.label}>4. ë¶„ì„ ê²°ê³¼</label>
          <div style={styles.resultCard}>
            <div style={styles.resultRow}>
              <span style={styles.resultLabel}>ë„êµ¬ëª…:</span>
              <input
                style={styles.input}
                value={analysisResult.tool_name}
                onChange={e => setAnalysisResult({ ...analysisResult, tool_name: e.target.value })}
              />
            </div>
            <div style={styles.resultRow}>
              <span style={styles.resultLabel}>ì„¤ëª…:</span>
              <input
                style={styles.input}
                value={analysisResult.description}
                onChange={e => setAnalysisResult({ ...analysisResult, description: e.target.value })}
              />
            </div>
            <div style={styles.resultRow}>
              <span style={styles.resultLabel}>ì…ë ¥:</span>
              <span style={styles.resultValue}>
                {analysisResult.input_schema?.type} - {analysisResult.input_schema?.description}
              </span>
            </div>
            {analysisResult.input_schema?.args_format && (
              <div style={styles.resultRow}>
                <span style={styles.resultLabel}>ì¸ì:</span>
                <code style={styles.codeInline}>{analysisResult.input_schema.args_format}</code>
              </div>
            )}
            <div style={styles.resultRow}>
              <span style={styles.resultLabel}>ì¶œë ¥:</span>
              <span style={styles.resultValue}>
                {analysisResult.output_schema?.type} - {analysisResult.output_schema?.description}
              </span>
            </div>
            {analysisResult.params_schema?.length > 0 && (
              <div style={{ marginTop: 8, borderTop: '1px solid #e0e0e0', paddingTop: 8 }}>
                <div style={{ fontSize: 12, fontWeight: 600, color: '#555', marginBottom: 6 }}>
                  ì¶”ê°€ íŒŒë¼ë¯¸í„° ({analysisResult.params_schema.length}ê°œ)
                </div>
                {analysisResult.params_schema.map((p, idx) => (
                  <div key={idx} style={{ fontSize: 12, color: '#666', marginBottom: 4 }}>
                    <span style={{ fontWeight: 500 }}>{p.label}</span>
                    <span style={{ color: '#999' }}> ({p.key}, {p.type})</span>
                    {p.required && <span style={{ color: '#c0392b', marginLeft: 4 }}>*í•„ìˆ˜</span>}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Step 5: Register */}
      {analysisResult && (
        <div style={styles.section}>
          <label style={styles.label}>5. ë„êµ¬ ë“±ë¡</label>
          <button
            style={styles.primaryBtn}
            onClick={handleRegister}
            disabled={registering}
          >
            {registering ? 'ë“±ë¡ ì¤‘ (ì–´ëŒ‘í„° ì½”ë“œ ìƒì„±)...' : 'ë“±ë¡í•˜ê¸°'}
          </button>
        </div>
      )}
    </div>
  );

  const renderToolOutput = (toolOutput) => {
    if (!toolOutput) return null;
    try {
      // JSON íŒŒì‹± ì‹œë„
      const parsed = JSON.parse(toolOutput);
      // JSON ì „ì²´ë¥¼ ë³´ê¸° ì¢‹ê²Œ í‘œì‹œ
      return (
        <pre style={{
          ...styles.codePreview,
          maxHeight: '400px',  // ìŠ¤í¬ë¡¤ ê°€ëŠ¥
          overflow: 'auto',
          fontSize: 11,
          lineHeight: 1.6,
          whiteSpace: 'pre-wrap',  // ì¤„ë°”ê¿ˆ í—ˆìš©
          wordBreak: 'break-word'  // ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ
        }}>
          {JSON.stringify(parsed, null, 2)}
        </pre>
      );
    } catch {
      // JSONì´ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ í‘œì‹œ
      return (
        <pre style={{
          ...styles.codePreview,
          maxHeight: '400px',  // ìŠ¤í¬ë¡¤ ê°€ëŠ¥
          overflow: 'auto',
          whiteSpace: 'pre-wrap',
          wordBreak: 'break-word'
        }}>
          {toolOutput}
        </pre>
      );
    }
  };

  const renderGenerate = () => (
    <div style={styles.content}>
      <div style={styles.header}>
        <button style={styles.backBtn} onClick={() => setView('main')}>â† ëª©ë¡</button>
        <h3 style={styles.title}>AIë¡œ ë„êµ¬ ìƒì„±</h3>
      </div>

      {/* Step 1: Description Input */}
      <div style={styles.section}>
        <label style={styles.label}>1. ì›í•˜ëŠ” ë„êµ¬ ê¸°ëŠ¥ ì„¤ëª…</label>
        <textarea
          style={styles.textarea}
          placeholder="ì˜ˆ: ê³µì • ê°„ ê±°ë¦¬ë¥¼ ê³„ì‚°í•´ì„œ ìµœì†Œ ê±°ë¦¬ë³´ë‹¤ ê°€ê¹Œìš´ ê³µì •ë“¤ì„ ì°¾ì•„ì£¼ëŠ” ë„êµ¬ê°€ í•„ìš”í•´. ìµœì†Œ ê±°ë¦¬ëŠ” íŒŒë¼ë¯¸í„°ë¡œ ë°›ê³  ì‹¶ì–´."
          value={genDescription}
          onChange={e => setGenDescription(e.target.value)}
          rows={4}
        />
        <button
          style={{ ...styles.primaryBtn, marginTop: 8 }}
          onClick={handleGenerate}
          disabled={generating || !genDescription.trim()}
        >
          {generating ? 'ìƒì„± ì¤‘...' : 'ìŠ¤í¬ë¦½íŠ¸ ìƒì„±'}
        </button>
      </div>

      {/* Step 2: Generated Result */}
      {generatedResult && (
        <>
          <div style={styles.section}>
            <label style={styles.label}>2. ìƒì„±ëœ ë„êµ¬ ì •ë³´</label>
            <div style={styles.resultCard}>
              <div style={styles.resultRow}>
                <span style={styles.resultLabel}>ë„êµ¬ëª…:</span>
                <span style={styles.resultValue}>{generatedResult.tool_name}</span>
              </div>
              <div style={styles.resultRow}>
                <span style={styles.resultLabel}>ì„¤ëª…:</span>
                <span style={styles.resultValue}>{generatedResult.description}</span>
              </div>
              {generatedResult.suggested_params?.length > 0 && (
                <div style={{ marginTop: 8, borderTop: '1px solid #e0e0e0', paddingTop: 8 }}>
                  <div style={{ fontSize: 12, fontWeight: 600, color: '#555', marginBottom: 6 }}>
                    ì˜ˆìƒ íŒŒë¼ë¯¸í„° ({generatedResult.suggested_params.length}ê°œ)
                  </div>
                  {generatedResult.suggested_params.map((p, idx) => (
                    <div key={idx} style={{ fontSize: 12, color: '#666', marginBottom: 4 }}>
                      <span style={{ fontWeight: 500 }}>{p.label}</span>
                      <span style={{ color: '#999' }}> ({p.key}, {p.type})</span>
                      {p.required && <span style={{ color: '#c0392b', marginLeft: 4 }}>*í•„ìˆ˜</span>}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          <div style={styles.section}>
            <label style={styles.label}>3. ì½”ë“œ í™•ì¸ ë° ìˆ˜ì •</label>
            <textarea
              style={{ ...styles.textarea, fontFamily: 'monospace', fontSize: 11, minHeight: 300 }}
              value={editedCode}
              onChange={e => setEditedCode(e.target.value)}
            />
          </div>

          <div style={styles.section}>
            <label style={styles.label}>4. ë„êµ¬ ë“±ë¡</label>
            <button
              style={styles.primaryBtn}
              onClick={handleRegisterGenerated}
              disabled={registering || !editedCode.trim()}
            >
              {registering ? 'ë“±ë¡ ì¤‘ (ë¶„ì„ + ì–´ëŒ‘í„° ìƒì„±)...' : 'ì´ ì½”ë“œë¡œ ë“±ë¡í•˜ê¸°'}
            </button>
          </div>
        </>
      )}

      {error && <div style={styles.error}>{error}</div>}
    </div>
  );

  const renderDetail = () => (
    <div style={styles.content}>
      <div style={styles.header}>
        <button style={styles.backBtn} onClick={() => setView('main')}>â† ëª©ë¡</button>
        <h3 style={styles.title}>{selectedTool?.tool_name}</h3>
      </div>

      <div style={styles.section}>
        <div style={styles.resultCard}>
          <div style={styles.resultRow}>
            <span style={styles.resultLabel}>ID:</span>
            <span style={styles.resultValue}>{selectedTool?.tool_id}</span>
          </div>
          <div style={styles.resultRow}>
            <span style={styles.resultLabel}>ì„¤ëª…:</span>
            <span style={styles.resultValue}>{selectedTool?.description}</span>
          </div>
          <div style={styles.resultRow}>
            <span style={styles.resultLabel}>íƒ€ì…:</span>
            <span style={styles.badge}>{selectedTool?.execution_type}</span>
          </div>
        </div>
      </div>

      {/* Parameter Input Form */}
      {selectedTool?.params_schema?.length > 0 && (
        <div style={styles.section}>
          <label style={styles.label}>íŒŒë¼ë¯¸í„° ì„¤ì •</label>
          <div style={styles.resultCard}>
            {selectedTool.params_schema.map(p => (
              <div key={p.key} style={{ marginBottom: 10 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 4 }}>
                  <span style={{ fontSize: 13, fontWeight: 600, color: '#333' }}>{p.label}</span>
                  {p.required && <span style={{ color: '#c0392b', fontSize: 11 }}>*</span>}
                </div>
                {p.description && (
                  <div style={{ fontSize: 11, color: '#888', marginBottom: 4 }}>{p.description}</div>
                )}
                <input
                  style={styles.paramInput}
                  type={p.type === 'number' ? 'number' : 'text'}
                  placeholder={p.default != null ? `ê¸°ë³¸ê°’: ${p.default}` : (p.required ? '' : '(ì„ íƒ)')}
                  value={toolParams[p.key] ?? ''}
                  onChange={e => setToolParams(prev => ({ ...prev, [p.key]: e.target.value }))}
                />
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Execute */}
      <div style={styles.section}>
        <button
          style={styles.primaryBtn}
          onClick={handleExecute}
          disabled={executing}
        >
          {executing ? 'ì‹¤í–‰ ì¤‘...' : 'ì‹¤í–‰í•˜ê¸°'}
        </button>
      </div>

      {/* Execution Result */}
      {execResult && (
        <div style={styles.section}>
          <label style={styles.label}>ì‹¤í–‰ ê²°ê³¼</label>
          <div style={{
            ...styles.resultCard,
            borderLeft: `4px solid ${execResult.success ? '#50c878' : '#ff6b6b'}`,
          }}>
            <div style={{ fontWeight: 'bold', marginBottom: 6, color: execResult.success ? '#2d7a3a' : '#c0392b' }}>
              {execResult.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}
            </div>
            <div style={{ fontSize: 13, marginBottom: 6 }}>{execResult.message}</div>
            {execResult.execution_time_sec != null && (
              <div style={{ fontSize: 12, color: '#888', marginBottom: 8 }}>
                ì‹¤í–‰ ì‹œê°„: {execResult.execution_time_sec.toFixed(1)}ì´ˆ
              </div>
            )}

            {/* Pre-process Adapter Code */}
            {toolDetail?.adapter?.pre_process_code && (
              <details style={{ marginTop: 8 }}>
                <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666', fontWeight: 600 }}>
                  ğŸ”§ Pre-process ì½”ë“œ (BOP â†’ ë„êµ¬ ì…ë ¥)
                </summary>
                <pre style={{
                  ...styles.codePreview,
                  maxHeight: '300px',
                  overflow: 'auto',
                  fontSize: 11,
                  lineHeight: 1.6,
                  whiteSpace: 'pre-wrap',
                  wordBreak: 'break-word'
                }}>
                  {toolDetail.adapter.pre_process_code}
                </pre>
              </details>
            )}

            {/* Tool Input Preview */}
            {execResult.tool_input && (
              <details style={{ marginTop: 8 }}>
                <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666', fontWeight: 600 }}>
                  ğŸ“¥ ë„êµ¬ ì…ë ¥ ë°ì´í„° (ì–´ëŒ‘í„° ë³€í™˜ í›„)
                </summary>
                {renderToolOutput(execResult.tool_input)}
              </details>
            )}

            {/* Tool Output Preview */}
            {execResult.tool_output && (
              <details style={{ marginTop: 8 }}>
                <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666', fontWeight: 600 }}>
                  ğŸ“¤ ë„êµ¬ ì¶œë ¥ ê²°ê³¼ (ìŠ¤í¬ë¦½íŠ¸ ìƒì„±)
                </summary>
                {renderToolOutput(execResult.tool_output)}
              </details>
            )}

            {/* Post-process Adapter Code */}
            {toolDetail?.adapter?.post_process_code && (
              <details style={{ marginTop: 8 }}>
                <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666', fontWeight: 600 }}>
                  ğŸ”§ Post-process ì½”ë“œ (ë„êµ¬ ì¶œë ¥ â†’ BOP)
                </summary>
                <pre style={{
                  ...styles.codePreview,
                  maxHeight: '300px',
                  overflow: 'auto',
                  fontSize: 11,
                  lineHeight: 1.6,
                  whiteSpace: 'pre-wrap',
                  wordBreak: 'break-word'
                }}>
                  {toolDetail.adapter.post_process_code}
                </pre>
              </details>
            )}

            {execResult.stdout && (
              <details style={{ marginTop: 8 }}>
                <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666' }}>stdout</summary>
                <pre style={styles.codePreview}>{execResult.stdout}</pre>
              </details>
            )}
            {execResult.stderr && (
              <details style={{ marginTop: 4 }}>
                <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666' }}>ì‹¤í–‰ ë¡œê·¸</summary>
                <pre style={{ ...styles.codePreview }}>{execResult.stderr}</pre>
              </details>
            )}
          </div>
        </div>
      )}

      {/* Apply to BOP Section */}
      {pendingResult && bopChanges && (
        <div style={styles.section}>
          <label style={styles.label}>BOP ë³€ê²½ ì‚¬í•­</label>
          <div style={{ ...styles.resultCard, borderLeft: '4px solid #f39c12', marginBottom: 12 }}>
            {bopChanges.map((change, idx) => (
              <div key={idx} style={{ fontSize: 13, marginBottom: 6 }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                  <span style={{
                    display: 'inline-block',
                    padding: '2px 6px',
                    borderRadius: 3,
                    fontSize: 11,
                    fontWeight: 600,
                    backgroundColor: change.type === 'add' ? '#d4edda' : change.type === 'remove' ? '#f8d7da' : '#fff3cd',
                    color: change.type === 'add' ? '#155724' : change.type === 'remove' ? '#721c24' : '#856404',
                  }}>
                    {change.type === 'add' ? 'ì¶”ê°€' : change.type === 'remove' ? 'ì‚­ì œ' : 'ìˆ˜ì •'}
                  </span>
                  <span>{change.field} {change.count}ê°œ</span>
                </div>
                {change.details && change.details.length > 0 && (
                  <div style={{ marginLeft: 8, marginTop: 4, fontSize: 11, color: '#666' }}>
                    {change.details.slice(0, 5).map((detail, i) => (
                      <div key={i}>â€¢ {detail}</div>
                    ))}
                    {change.details.length > 5 && <div>â€¢ ... ì™¸ {change.details.length - 5}ê°œ</div>}
                  </div>
                )}
              </div>
            ))}
          </div>
          <div style={{ display: 'flex', gap: 8 }}>
            <button style={styles.applyBtn} onClick={handleApplyToBop}>
              ë°˜ì˜í•˜ê¸°
            </button>
            <button style={styles.secondaryBtn} onClick={handleCancelApply}>
              ì·¨ì†Œ
            </button>
          </div>
        </div>
      )}

      {/* AI Improvement Section */}
      {execResult && (
        <div style={{ ...styles.section, borderTop: '1px solid #e0e0e0', paddingTop: 16, marginTop: 16 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
            <label style={{ ...styles.label, marginBottom: 0 }}>AI ê°œì„ </label>
            <button
              style={showImprove ? styles.secondaryBtn : styles.aiBtn}
              onClick={() => { setShowImprove(!showImprove); setImproveResult(null); setImproveFeedback(''); }}
            >
              {showImprove ? 'ì ‘ê¸°' : 'âœ¨ AIë¡œ ê°œì„ í•˜ê¸°'}
            </button>
          </div>

          {showImprove && (
            <>
              {/* ìˆ˜ì • ë²”ìœ„ ì„ íƒ */}
              <div style={{ marginBottom: 12 }}>
                <div style={{ fontSize: 12, color: '#666', marginBottom: 6 }}>ìˆ˜ì • ë²”ìœ„ ì„ íƒ:</div>
                <div style={{ display: 'flex', gap: 12, flexWrap: 'wrap' }}>
                  <label style={styles.checkboxLabel}>
                    <input
                      type="checkbox"
                      checked={improveScope.adapter}
                      onChange={e => setImproveScope(prev => ({ ...prev, adapter: e.target.checked }))}
                    />
                    ì–´ëŒ‘í„° ì½”ë“œ
                  </label>
                  <label style={styles.checkboxLabel}>
                    <input
                      type="checkbox"
                      checked={improveScope.params}
                      onChange={e => setImproveScope(prev => ({ ...prev, params: e.target.checked }))}
                    />
                    íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ
                  </label>
                  <label style={styles.checkboxLabel}>
                    <input
                      type="checkbox"
                      checked={improveScope.script}
                      onChange={e => setImproveScope(prev => ({ ...prev, script: e.target.checked }))}
                    />
                    ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ
                  </label>
                </div>
              </div>

              {/* í”¼ë“œë°± ì…ë ¥ */}
              <textarea
                style={{ ...styles.textarea, marginBottom: 8 }}
                placeholder="ì˜ˆ: ì¥ì• ë¬¼ ì •ë³´ëŠ” BOPì—ì„œ ê°€ì ¸ì˜¤ê³ , ë²½ ê°„ê²©ì€ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì„ ìˆ˜ ìˆê²Œ í•´ì¤˜."
                value={improveFeedback}
                onChange={e => setImproveFeedback(e.target.value)}
                rows={3}
              />
              <button
                style={styles.primaryBtn}
                onClick={handleImprove}
                disabled={improving || !improveFeedback.trim() || (!improveScope.adapter && !improveScope.params && !improveScope.script)}
              >
                {improving ? 'ê°œì„  ì¤‘...' : 'ê°œì„  ìš”ì²­'}
              </button>

              {/* ê°œì„  ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° */}
              {improveResult && improveResult.success && (
                <div style={{ marginTop: 16 }}>
                  <div style={{ ...styles.resultCard, borderLeft: '4px solid #667eea' }}>
                    <div style={{ fontWeight: 600, marginBottom: 8, color: '#667eea' }}>ê°œì„  ë¯¸ë¦¬ë³´ê¸°</div>
                    <div style={{ fontSize: 13, marginBottom: 8 }}>{improveResult.explanation}</div>

                    {improveResult.changes_summary?.length > 0 && (
                      <div style={{ marginBottom: 12 }}>
                        <div style={{ fontSize: 12, fontWeight: 600, color: '#555', marginBottom: 4 }}>ë³€ê²½ ì‚¬í•­:</div>
                        {improveResult.changes_summary.map((change, idx) => (
                          <div key={idx} style={{ fontSize: 12, color: '#666', marginLeft: 8 }}>â€¢ {change}</div>
                        ))}
                      </div>
                    )}

                    {/* ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° í† ê¸€ */}
                    {improveResult.preview?.pre_process_code && (
                      <details style={{ marginTop: 8 }}>
                        <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666' }}>Pre-process ì½”ë“œ</summary>
                        <pre style={{ ...styles.codePreview, maxHeight: 150 }}>{improveResult.preview.pre_process_code}</pre>
                      </details>
                    )}
                    {improveResult.preview?.post_process_code && (
                      <details style={{ marginTop: 4 }}>
                        <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666' }}>Post-process ì½”ë“œ</summary>
                        <pre style={{ ...styles.codePreview, maxHeight: 150 }}>{improveResult.preview.post_process_code}</pre>
                      </details>
                    )}
                    {improveResult.preview?.params_schema && (
                      <details style={{ marginTop: 4 }}>
                        <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666' }}>íŒŒë¼ë¯¸í„° ìŠ¤í‚¤ë§ˆ</summary>
                        <pre style={{ ...styles.codePreview, maxHeight: 150 }}>{JSON.stringify(improveResult.preview.params_schema, null, 2)}</pre>
                      </details>
                    )}
                    {improveResult.preview?.script_code && (
                      <details style={{ marginTop: 4 }}>
                        <summary style={{ cursor: 'pointer', fontSize: 12, color: '#666' }}>ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ</summary>
                        <pre style={{ ...styles.codePreview, maxHeight: 200 }}>{improveResult.preview.script_code}</pre>
                      </details>
                    )}
                  </div>

                  {/* ì ìš© ë²„íŠ¼ */}
                  <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
                    <button
                      style={styles.applyBtn}
                      onClick={() => handleApplyImprovement(true)}
                      disabled={applying}
                    >
                      {applying ? 'ì ìš© ì¤‘...' : `ìƒˆ ë²„ì „ìœ¼ë¡œ ì €ì¥ (${getNextVersionLabel(selectedTool?.tool_id)})`}
                    </button>
                    <button
                      style={styles.dangerBtn}
                      onClick={() => handleApplyImprovement(false)}
                      disabled={applying}
                    >
                      í˜„ì¬ ë„êµ¬ì— ë®ì–´ì“°ê¸°
                    </button>
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      )}

      {/* Delete */}
      <div style={{ ...styles.section, borderTop: '1px solid #eee', paddingTop: 16, marginTop: 16 }}>
        <button style={styles.dangerBtn} onClick={handleDelete}>ì‚­ì œí•˜ê¸°</button>
      </div>

      {error && <div style={styles.error}>{error}</div>}
    </div>
  );

  return (
    <div style={styles.container}>
      {/* Main view */}
      {view === 'main' && renderTools()}

      {/* Upload view */}
      {view === 'upload' && renderUpload()}

      {/* AI Generate view */}
      {view === 'generate' && renderGenerate()}

      {/* Detail view */}
      {view === 'detail' && renderDetail()}
    </div>
  );
}

const styles = {
  container: {
    height: '100%',
    display: 'flex',
    flexDirection: 'column',
    backgroundColor: '#fff',
  },
  content: {
    padding: '16px',
    overflow: 'auto',
    flex: 1,
  },
  header: {
    display: 'flex',
    alignItems: 'center',
    gap: '12px',
    marginBottom: '16px',
  },
  title: {
    margin: 0,
    fontSize: '16px',
    fontWeight: 'bold',
    flex: 1,
  },
  section: {
    marginBottom: '16px',
  },
  label: {
    display: 'block',
    fontSize: '13px',
    fontWeight: '600',
    color: '#555',
    marginBottom: '8px',
  },
  info: {
    textAlign: 'center',
    color: '#888',
    padding: '20px',
  },
  emptyState: {
    textAlign: 'center',
    color: '#666',
    padding: '40px 20px',
  },
  card: {
    padding: '12px 14px',
    border: '1px solid #e0e0e0',
    borderRadius: '6px',
    marginBottom: '8px',
    cursor: 'pointer',
    transition: 'background-color 0.15s',
    backgroundColor: '#fafafa',
  },
  cardHeader: {
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: '4px',
  },
  cardName: {
    fontWeight: '600',
    fontSize: '14px',
  },
  cardDesc: {
    fontSize: '12px',
    color: '#777',
  },
  badge: {
    fontSize: '11px',
    padding: '2px 8px',
    borderRadius: '10px',
    backgroundColor: '#e3f2fd',
    color: '#1565c0',
    fontWeight: '500',
  },
  primaryBtn: {
    padding: '8px 16px',
    backgroundColor: '#4a90e2',
    color: 'white',
    border: 'none',
    borderRadius: '4px',
    fontSize: '13px',
    cursor: 'pointer',
    fontWeight: 'bold',
  },
  secondaryBtn: {
    padding: '8px 16px',
    backgroundColor: '#f0f0f0',
    color: '#333',
    border: '1px solid #ccc',
    borderRadius: '4px',
    fontSize: '13px',
    cursor: 'pointer',
  },
  backBtn: {
    padding: '4px 10px',
    backgroundColor: 'transparent',
    color: '#4a90e2',
    border: '1px solid #4a90e2',
    borderRadius: '4px',
    fontSize: '12px',
    cursor: 'pointer',
  },
  applyBtn: {
    padding: '10px 20px',
    backgroundColor: '#50c878',
    color: 'white',
    border: 'none',
    borderRadius: '4px',
    fontSize: '14px',
    cursor: 'pointer',
    fontWeight: 'bold',
    flex: 1,
  },
  paramInput: {
    width: '100%',
    padding: '6px 10px',
    border: '1px solid #ddd',
    borderRadius: '4px',
    fontSize: '13px',
    boxSizing: 'border-box',
  },
  dangerBtn: {
    padding: '8px 16px',
    backgroundColor: '#ff6b6b',
    color: 'white',
    border: 'none',
    borderRadius: '4px',
    fontSize: '13px',
    cursor: 'pointer',
    fontWeight: 'bold',
  },
  codePreview: {
    backgroundColor: '#f5f5f5',
    border: '1px solid #ddd',
    borderRadius: '4px',
    padding: '10px',
    fontSize: '11px',
    lineHeight: '1.4',
    overflow: 'auto',
    maxHeight: 'none',  // ì œí•œ ì—†ìŒ (ê°œë³„ì ìœ¼ë¡œ í•„ìš”ì‹œ ì˜¤ë²„ë¼ì´ë“œ)
    whiteSpace: 'pre-wrap',
    wordBreak: 'break-all',
    fontFamily: 'monospace',
  },
  resultCard: {
    backgroundColor: '#f9f9f9',
    border: '1px solid #e0e0e0',
    borderRadius: '6px',
    padding: '12px',
  },
  resultRow: {
    display: 'flex',
    alignItems: 'center',
    gap: '8px',
    marginBottom: '8px',
    fontSize: '13px',
  },
  resultLabel: {
    fontWeight: '600',
    color: '#555',
    minWidth: '50px',
  },
  resultValue: {
    color: '#333',
  },
  input: {
    flex: 1,
    padding: '4px 8px',
    border: '1px solid #ddd',
    borderRadius: '3px',
    fontSize: '13px',
  },
  error: {
    color: '#c0392b',
    backgroundColor: '#fdecea',
    padding: '8px 12px',
    fontSize: '13px',
    borderBottom: '1px solid #f5c6cb',
  },
  codeInline: {
    backgroundColor: '#f0f0f0',
    padding: '2px 6px',
    borderRadius: '3px',
    fontSize: '11px',
    fontFamily: 'monospace',
    color: '#333',
  },
  aiBtn: {
    padding: '8px 16px',
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    color: 'white',
    border: 'none',
    borderRadius: '4px',
    fontSize: '13px',
    cursor: 'pointer',
    fontWeight: 'bold',
  },
  textarea: {
    width: '100%',
    padding: '10px',
    border: '1px solid #ddd',
    borderRadius: '4px',
    fontSize: '13px',
    resize: 'vertical',
    boxSizing: 'border-box',
    lineHeight: 1.5,
  },
  checkboxLabel: {
    display: 'flex',
    alignItems: 'center',
    gap: 4,
    fontSize: 12,
    color: '#555',
    cursor: 'pointer',
  },
};

export default ToolsPanel;
